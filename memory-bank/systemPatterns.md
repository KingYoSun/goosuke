# Goosuke システムパターン

## システムアーキテクチャ

Goosuke は以下の主要コンポーネントで構成されています：

```
                       ┌────────────────────────────────────┐
                       │            コンテナ                 │
   ┌─────────┐        │  ┌────────┐      ┌──────────────┐  │       ┌─────────────┐
   │ Slack   │◄───────┼──┤ 発火    │◄────┤ 実行レイヤー  │   │      │ Notion      │
   │ Teams   │        │  │ レイヤー│      │ (Goose CLI)  │  │      │ Google Drive│
   │ Email   │────────┼─►│        │─────►│ Extensions   │──┼─────►│ JIRA        │
   └─────────┘        │  └────────┘      └──────────────┘  │      │ その他      │
                      │            ▲          ▲            │      └─────────────┘
                      └────────────┼──────────┼────────────┘
                                   │          │
                          ┌────────┘          └────────┐
                          │                            │
                  ┌───────┴────────┐         ┌─────────┴─────────┐
                  │   認証サービス  │         │ ストレージサービス  │
                  └────────────────┘         └───────────────────┘
```

### 主要コンポーネント

#### 1. 発火レイヤー
発火レイヤーは、システムへの入力点を受け取り、タスクを生成するコンポーネントです。

**主な役割**:
- 「アクション」の受け取り（APIリクエスト、Webhook、Botなど）
- コンテキストの抽出
- タスクの生成
- 認証・認可処理

**技術実装**:
- FastAPI（RESTful API）
- Pydantic（データ検証）
- SQLAlchemy（データベースアクセス）
- JWT（認証）

#### 2. 実行レイヤー
実行レイヤーは、発火レイヤーから受け取ったタスクを実行するコンポーネントです。

**主な役割**:
- タスクの実行
- Goose CLIの呼び出し
- 拡張機能の管理
- 実行結果の処理

**技術実装**:
- Goose CLI
- Python サブプロセス
- 拡張機能システム

#### 3. 認証サービス
認証サービスは、ユーザー認証と認可を担当するコンポーネントです。

**技術実装**:
- JWT（JSON Web Token）
- Passlib（パスワードハッシュ）

#### 4. ストレージサービス
ストレージサービスは、データの永続化を担当するコンポーネントです。

**技術実装**:
- SQLite（小規模用）
- SQLAlchemy（ORM）
- Alembic（マイグレーション）

## 設計パターン

### 1. アクションとタスクのパターン

Goosuke の中核となる概念は「アクション」と「タスク」です：

- **アクション**: システムへの入力点（APIリクエスト、Slack/Discord botのメッセージ、Webhookなど）
- **タスクテンプレート**: ユーザーが望む動作を記述した「プロンプト」と実行タイプを定義したもの
- **タスク実行**: タスクテンプレートと「コンテキスト」を組み合わせた実際の実行インスタンス

このパターンにより、新しいアクションとタスクテンプレートを定義するだけで、様々な作業を自動化できます。

### 2. レイヤードアーキテクチャ

Goosuke は以下のレイヤーで構成されています：

1. **プレゼンテーションレイヤー**: API、Webhook、Botなどのインターフェース
2. **アプリケーションレイヤー**: ビジネスロジック、サービス
3. **ドメインレイヤー**: モデル、エンティティ
4. **インフラストラクチャレイヤー**: データベース、外部サービス連携

### 3. サービスパターン

各機能は独立したサービスとして実装されています：

- **UserService**: ユーザー管理
- **ActionService**: アクション管理
- **TaskService**: タスク管理
- **ExtensionService**: 拡張機能管理
- **DiscordService**: Discord連携

### 4. 依存性注入パターン

FastAPIの依存性注入システムを活用して、コンポーネント間の結合度を低減しています。

### 5. 非同期コンテキスト管理パターン

データベース接続などのリソースを非同期コンテキスト管理で効率的に扱います。

```python
@asynccontextmanager
async def _get_db_context():
    async with async_session() as session:
        try:
            yield session
            await session.commit()
        except Exception:
            await session.rollback()
            raise
```

## データフロー

### 基本フロー

1. ユーザーがDiscordで鉛筆リアクションを付ける（アクション）
2. Discord Botがリアクションを検出
3. DiscordConfigServiceが設定を取得
4. ActionConfigServiceが関連するアクションを取得
5. メッセージの内容からコンテキストを抽出
6. アクションに関連するタスクテンプレートを取得
7. タスクテンプレートとコンテキストからタスク実行を生成
8. 生成されたタスク実行を実行レイヤーに渡す
9. 実行レイヤーがGoose CLIを使用してタスクを実行
10. 結果をDiscord Botを通じてチャンネルに返送

### 拡張機能設定同期フロー

1. アプリケーション起動時に`ExtensionService`のインスタンスを作成
2. `sync_from_goose`メソッドを呼び出し、Gooseの設定ファイルから拡張機能設定を読み取る
3. 読み取った設定をGoosukeのデータベースに反映する
4. `sync_to_goose`メソッドを呼び出し、Goosukeのデータベースから拡張機能設定を読み取る
5. 読み取った設定をGooseの設定ファイルに反映する