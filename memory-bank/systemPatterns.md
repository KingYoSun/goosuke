# Goosuke システムパターン

## システムアーキテクチャ

Goosuke は以下の主要コンポーネントで構成されています：

```
                    ┌────────────────────────────────────┐
                    │            コンテナ                 │
┌─────────┐        │  ┌────────┐      ┌──────────────┐  │       ┌─────────────┐
│ Slack   │◄───────┼──┤ 発火    │◄────┤ 実行レイヤー  │   │      │ Notion      │
│ Teams   │        │  │ レイヤー│      │ (Goose CLI)  │  │      │ Google Drive│
│ Email   │────────┼─►│        │─────►│ Extensions   │──┼─────►│ JIRA        │
└─────────┘        │  └────────┘      └──────────────┘  │      │ その他      │
                   │            ▲          ▲            │      └─────────────┘
                   └────────────┼──────────┼────────────┘
                                │          │
                       ┌────────┘          └────────┐
                       │                            │
               ┌───────┴────────┐         ┌─────────┴─────────┐
               │   認証サービス  │         │ ストレージサービス  │
               └────────────────┘         └───────────────────┘
```

### 主要コンポーネント

#### 1. 発火レイヤー

発火レイヤーは、システムへの入力点を受け取り、タスクを生成するコンポーネントです。

**主な役割**:
- 「アクション」の受け取り（APIリクエスト、Webhook、Botなど）
- コンテキストの抽出
- タスクの生成
- 認証・認可処理
- リクエスト検証とエラーハンドリング

**技術実装**:
- FastAPI（RESTful API）
- Pydantic（データ検証）
- SQLAlchemy（データベースアクセス）
- JWT（認証）

#### 2. 実行レイヤー

実行レイヤーは、発火レイヤーから受け取ったタスクを実行するコンポーネントです。

**主な役割**:
- タスクの実行
- Goose CLIの呼び出し
- 拡張機能の管理
- 実行結果の処理

**技術実装**:
- Goose CLI
- Python サブプロセス
- 拡張機能システム

#### 3. 認証サービス

認証サービスは、ユーザー認証と認可を担当するコンポーネントです。

**主な役割**:
- ユーザー認証
- トークン管理
- アクセス制御

**技術実装**:
- JWT（JSON Web Token）
- Passlib（パスワードハッシュ）
- Python-jose（JWT実装）

#### 4. ストレージサービス

ストレージサービスは、データの永続化を担当するコンポーネントです。

**主な役割**:
- データの永続化
- マイグレーション管理
- データアクセス

**技術実装**:
- SQLite（小規模用）
- SQLAlchemy（ORM）
- Alembic（マイグレーション）

## 設計パターン

### 1. アクションとタスクのパターン

Goosuke の中核となる概念は「アクション」と「タスク」です：

- **アクション**: システムへの入力点（APIリクエスト、Slack/Discord botのメッセージ、Webhookなど）
- **タスク**: アクションから得られた「コンテキスト」と、ユーザーが望む動作を記述した「プロンプト」のセット

このパターンにより、新しいアクションとタスクを定義するだけで、様々な作業を自動化できます。

### 2. レイヤードアーキテクチャ

Goosuke は以下のレイヤーで構成されています：

1. **プレゼンテーションレイヤー**: API、Webhook、Botなどのインターフェース
2. **アプリケーションレイヤー**: ビジネスロジック、サービス
3. **ドメインレイヤー**: モデル、エンティティ
4. **インフラストラクチャレイヤー**: データベース、外部サービス連携

### 3. サービスパターン

各機能は独立したサービスとして実装されています：

- **UserService**: ユーザー管理
- **ActionService**: アクション管理
- **TaskService**: タスク管理
- **ExtensionService**: 拡張機能管理
- **DiscordService**: Discord連携

### 4. 依存性注入パターン

FastAPIの依存性注入システムを活用して、コンポーネント間の結合度を低減しています。

```python
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@app.get("/users/")
def read_users(db: Session = Depends(get_db)):
    users = db.query(User).all()
    return users
```

### 5. リポジトリパターン

データアクセスはリポジトリパターンを使用して抽象化されています。

```python
class UserRepository:
    def __init__(self, db: Session):
        self.db = db
    
    def get_all(self):
        return self.db.query(User).all()
    
    def get_by_id(self, user_id: int):
        return self.db.query(User).filter(User.id == user_id).first()
```

## コンポーネント間の関係

### 1. アクションとタスクの関係

アクションとタスクの関係は以下のようになります：

1. アクションが発生（APIリクエスト、Botメッセージなど）
2. 発火レイヤーがアクションを受け取る
3. コンテキスト抽出ルールに基づいてコンテキストを抽出
4. 関連するタスクを取得（またはテンプレートから新しいタスクを生成）
5. タスクを実行レイヤーに渡す
6. 実行レイヤーがタスクを実行
7. 結果を発火レイヤーに返す
8. 発火レイヤーが結果をレスポンスとして返す

### 2. 発火レイヤーと実行レイヤーの関係

発火レイヤーと実行レイヤーは以下のように連携します：

1. 発火レイヤーがタスクを生成
2. タスクを実行レイヤーに渡す
3. 実行レイヤーがタスクを実行
4. 実行結果を発火レイヤーに返す

### 3. 拡張機能システム

拡張機能システムは以下のカテゴリに分類されます：

- **コネクタ拡張**: 外部サービスとの接続（Slack, Notion, Google Workspace など）
- **処理拡張**: データ変換、フォーマット変更
- **ユーティリティ拡張**: 日付処理、テキスト操作、データ検証など
- **カスタム拡張**: 組織固有のビジネスロジック実装

## データフロー

### 基本フロー

1. ユーザーがSlackでGoosuke宛にメッセージを送信（アクション）
2. Slackからのwebhookが発火レイヤーのエンドポイントを呼び出し
3. 発火レイヤーがリクエストを処理し、認証を行う
4. メッセージの内容からコンテキストを抽出し、プロンプトと組み合わせてタスクを生成
5. 生成されたタスクを実行レイヤーに渡す
6. 実行レイヤーがGoose CLIを使用してタスクを実行し、必要に応じて拡張機能を使用
7. 結果を発火レイヤーを通じてSlackに返送

### 非同期処理フロー

長時間実行タスク用：

1. アクションを受信
2. タスクIDを生成して即時応答
3. タスクをバックグラウンドワーカーにキューイング
4. 処理完了時にコールバックURLに通知
5. ユーザーが結果を取得（プッシュまたはプル）