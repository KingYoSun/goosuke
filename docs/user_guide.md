# Goosuke ユーザーガイド

このガイドでは、Goosuke の基本的な使い方と、「発火レイヤー」と「実行レイヤー」の概念、そして「アクション」と「タスク」の関係性について説明します。

## 目次

1. [Goosuke の概要](#1-goosuke-の概要)
2. [アーキテクチャ](#2-アーキテクチャ)
3. [アクションとタスク](#3-アクションとタスク)
4. [基本的な使い方](#4-基本的な使い方)
5. [応用例](#5-応用例)
6. [トラブルシューティング](#6-トラブルシューティング)

## 1. Goosuke の概要

Goosuke は小～中規模組織向けの業務効率化ツールで、オープンソースのAIエージェント「Goose」とFastAPIを組み合わせたプラットフォームです。Dockerコンテナ環境で動作し、Discordと連携して、会議の要約作成などを自動化します。

### 主な機能

- **Discord連携**: Discordチャンネルでの会話を要約
- **拡張機能管理**: Goose拡張機能のインストールと管理
- **API**: RESTful APIによる柔軟な連携
- **認証**: JWTベースの認証システム

## 2. アーキテクチャ

Goosuke は以下の主要コンポーネントで構成されています：

```
                    ┌────────────────────────────────────┐
                    │            コンテナ                │
┌─────────┐        │  ┌────────┐      ┌──────────────┐  │      ┌─────────────┐
│ Slack   │◄───────┼──┤ 発火   │◄────┤ 実行レイヤー  │  │      │ Notion      │
│ Teams   │        │  │ レイヤー│      │ (Goose CLI)  │  │      │ Google Drive│
│ Email   │────────┼─►│        │─────►│ Extensions   │──┼─────►│ JIRA        │
└─────────┘        │  └────────┘      └──────────────┘  │      │ その他      │
                   │            ▲          ▲            │      └─────────────┘
                   └────────────┼──────────┼────────────┘
                                │          │
                       ┌────────┘          └────────┐
                       │                             │
               ┌───────┴────────┐         ┌─────────┴─────────┐
               │   認証サービス  │         │ ストレージサービス  │
               └────────────────┘         └───────────────────┘
```

### 2.1 発火レイヤー

発火レイヤーは、システムへの入力点（APIリクエスト、Slack/Discord botのメッセージ、Webhookなど）を受け取り、コンテキストとプロンプトをセットにしたタスクを生成します。

主な役割：
- 「アクション」の受け取り
- コンテキストの抽出
- タスクの生成
- 認証・認可処理
- リクエスト検証とエラーハンドリング

### 2.2 実行レイヤー

実行レイヤーは、発火レイヤーから受け取ったタスクを実行し、結果を返します。

主な役割：
- タスクの実行
- Goose CLIの呼び出し
- 拡張機能の管理
- 実行結果の処理

## 3. アクションとタスク

Goosuke の中核となる概念は「アクション」と「タスク」です：

### 3.1 アクション

アクションは、システムへの入力点を表します。例えば：

- APIリクエスト
- Slack/Discord botのメッセージ
- Webhook
- 定期実行ジョブ

アクションには以下の要素があります：

- **名前**: アクションの識別子
- **タイプ**: アクションの種類（api, discord, slack, webhook など）
- **設定**: アクション固有の設定
- **コンテキスト抽出ルール**: 入力データからコンテキストを抽出するためのルール
- **関連するタスク**: アクションがトリガーするタスク

### 3.2 タスク

タスクは、アクションから得られた「コンテキスト」と、ユーザーが望む動作を記述した「プロンプト」のセットです。

タスクには以下の要素があります：

- **名前**: タスクの識別子
- **タイプ**: タスクの種類（general, discord_summary など）
- **プロンプト**: ユーザーが望む動作を記述したプロンプト
- **コンテキスト**: アクションから得られたコンテキスト
- **テンプレート**: 再利用可能なタスクテンプレート
- **親子関係**: テンプレートから派生したタスク

### 3.3 アクションとタスクの関係

アクションとタスクの関係は以下のようになります：

1. アクションが発生（APIリクエスト、Botメッセージなど）
2. 発火レイヤーがアクションを受け取る
3. コンテキスト抽出ルールに基づいてコンテキストを抽出
4. 関連するタスクを取得（またはテンプレートから新しいタスクを生成）
5. タスクを実行レイヤーに渡す
6. 実行レイヤーがタスクを実行
7. 結果を発火レイヤーに返す
8. 発火レイヤーが結果をレスポンスとして返す

この設計により、新しいアクションとタスクを定義するだけで、様々な作業を自動化できます。

## 4. 基本的な使い方

### 4.1 タスクテンプレートの作成

タスクテンプレートは、再利用可能なタスクの雛形です。

```bash
# APIを使用してタスクテンプレートを作成
curl -X POST "http://localhost:8000/api/v1/tasks/" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "task_type": "template",
    "prompt": "以下の内容を要約してください: {content}",
    "name": "要約テンプレート",
    "is_template": true
  }'
```

### 4.2 アクションの作成

アクションは、タスクテンプレートと連携して、特定の入力に対して自動的にタスクを実行します。

```bash
# APIを使用してアクションを作成
curl -X POST "http://localhost:8000/api/v1/actions/" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Webhook要約",
    "action_type": "webhook",
    "context_rules": {
      "content": {
        "source": "text"
      }
    },
    "task_id": 1
  }'
```

### 4.3 アクションのトリガー

アクションをトリガーすると、関連するタスクが実行されます。

```bash
# APIを使用してアクションをトリガー
curl -X POST "http://localhost:8000/api/v1/actions/1/trigger" \
  -H "Content-Type: application/json" \
  -d '{
    "text": "要約したいテキスト..."
  }'
```

### 4.4 Discord連携の設定

1. [Discord Developer Portal](https://discord.com/developers/applications)でBotを作成
2. Botトークンを取得し、`.env`ファイルの`DISCORD_BOT_TOKEN`に設定
3. 必要な権限（メッセージの読み取り、送信、リアクションの追加など）を付与
4. Botを目的のサーバーに招待

### 4.5 会議要約機能の使用方法

1. Discordチャンネルで会話を行う
2. 要約したい会話の範囲のメッセージに ✏️（鉛筆）リアクションを付ける
3. Botが自動的に関連メッセージを収集し、要約を生成
4. 要約結果がチャンネルに投稿される

## 5. 応用例

### 5.1 定期レポート生成

1. レポート生成用のタスクテンプレートを作成
2. 定期実行用のアクションを作成（cron式で実行時間を指定）
3. アクションが定期的にトリガーされ、レポートを生成

### 5.2 Slack連携

1. Slack Appを作成し、Webhook URLを取得
2. Slack連携用のアクションを作成
3. Slackからのメッセージをトリガーとして、タスクを実行

### 5.3 カスタムワークフロー

1. 複数のタスクテンプレートを作成（データ取得、処理、レポート生成など）
2. ワークフロー用のアクションを作成
3. アクションがトリガーされると、複数のタスクが順次実行される

## 6. トラブルシューティング

### 6.1 アクションがトリガーされない

- アクションが有効になっているか確認
- コンテキスト抽出ルールが正しいか確認
- 関連するタスクが存在するか確認

### 6.2 タスクの実行に失敗する

- プロンプトが正しいか確認
- コンテキストが正しく抽出されているか確認
- Goose CLIの設定が正しいか確認

### 6.3 Discord Botが応答しない

- Botトークンが正しいか確認
- Botに必要な権限が付与されているか確認
- Botがサーバーに招待されているか確認

### 6.4 ログの確認

ログを確認することで、問題の原因を特定できます：

```bash
# Dockerコンテナのログを確認
docker-compose logs -f
```

## まとめ

Goosuke は「アクション」と「タスク」の2つの概念を中心に設計されています。この設計により、高い拡張性と操作の簡易さを両立し、様々な作業を自動化できます。

新しいアクションとタスクを定義するだけで、組織固有のニーズに合わせたカスタマイズが可能です。